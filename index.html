<html>
<head>
	<title>GEMU</title>
	<style>
		html, body {
			margin: 1;
			height: 100%;
			overflow: hidden;
			color:white;
			font-family:"Arial Black", Arial, sans-serif;
			font-size:150%;
			user-select: none;
			background-color: black;
		}
		#defmsg {
			margin-top:10%;
		}
		#myProgress {
			width:50%;
			background-color:gray;
			display:none;
		}
		#myBar {
			width:1%;
			height:30px;
			background-color:green;
		}
	</style>
</head>
<body>
<div>
	<center>
		<p id="defmsg">To run GEMU, you must have the Adobe NPAPI plugin installed on your computer!<br>
		Download here: https://goo.gl/eymjZM</p>
	</center>
	<div id="myProgress" style="margin: 0 auto;">
		<div id="myBar" align="left"></div>
	</div>
	<center>
		<div id="lodmsg" style="display:none;">It'll only take this long the first time running each ROM.</div>
	</center>
	<div id="emulator">
		
	</div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>

<script type="text/javascript">

	var romBytes = "";
	var fileType = "";
	var saveState = "";
	var loadState = "";
	
	var resizeOwnEmulator = function(width, height)
	{
		var emulator = $('#emulator');
		emulator.css('width', width);
		emulator.css('height', height);
	}
	
	function setUrl() {
		document.getElementById("defmsg").style.display = "none";
		var emulator = $('#emulator');
		//console.log('RUNLUA:print("retrived bytes: ' + romBytes + '")');
		if(emulator)
		{
			var flashvars = 
			{
				system : fileType,
				url : ''
			};
			var params = {};
			var attributes = {};

			params.allowscriptaccess = 'sameDomain';
			params.allowFullScreen = 'true';
			params.allowFullScreenInteractive = 'true';

			swfobject.embedSWF('flash/Nesbox.swf', 'emulator', '640', '480', '11.2.0', 'flash/expressInstall.swf', flashvars, params, attributes, onFlashLoad);
		} else {
			console.log("No emulator element!");
		}
	}
	
	var onFlashLoad = function(e) {
		if(e.success) {
			var flObj = document.getElementsByTagName("object")[0];
			flObj.tabIndex = "-1";
			flObj.focus();
			
			console.log("Flash loaded");
		}
	}
	
	function getFileFromByteArray(byteString) {
		var strBytes = byteString.split(" ");
		var bytes = [];
		for(i = 0; i < strBytes.length; i++) {
			bytes.push(parseInt(strBytes[i], 16));
		}
		var byteArray = new Uint8Array(bytes);
		var blob = new Blob([byteArray], {type: ""});
		var objectUrl = URL.createObjectURL(blob);
		return objectUrl;
		this.setUrl(objectUrl);
	}
	
	function loading(percent) {
		document.getElementById("defmsg").innerHTML = "Loading... " + percent + "%";
		document.getElementById("myBar").style.width = percent + "%";
		document.getElementById("myProgress").style.display = "block";
		document.getElementById("myProgress").style.backgroundColor = "gray";
		document.getElementById("defmsg").style.display = "block";
		document.getElementById("lodmsg").style.display = "block";
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj)
			flObj.style.display = "none";
	}
	
	function loaded() {
		document.getElementById("defmsg").style.display = "none";
		document.getElementById("myProgress").style.display = "none";
		document.getElementById("myProgress").style.backgroundColor = "black";
		document.getElementById("lodmsg").style.display = "none";
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj)
			flObj.style.display = "block";
	}
	
	function setRomBytes(byteString) {
		romBytes = byteString;
	}
	
	function addToRomBytes(byteString) {
		romBytes += byteString;
	}
	
	function corruptROM(amnt, method) {
		var newBytes = "";
		var hexchars = "0123456789abcdef";
		for(i = 0; i < romBytes.length; i+=3) {
			if(i % amnt == 1 && i > 1) {
				var corruptedByte = "";
				if(method == 0) {
					var randPointer = Math.floor(Math.random() * 15);
					corruptedByte += hexchars.substring(randPointer, randPointer+1);
					randPointer = Math.floor(Math.random() * 15);
					corruptedByte += hexchars.substring(randPointer, randPointer+1);
					corruptedByte += ":";
					console.log(corruptedByte, i);
					newBytes += corruptedByte;
				} else if (method == 1) {
					corruptedByte = parseInt(romBytes.substring(i, i+2), 16);
					corruptedByte++;
					corruptedByte = corruptedByte.toString(16);
					if(corruptedByte.length == 1) corruptedByte = "0" + corruptedByte;
					newBytes += corruptedByte + ":";
				} else {
					newBytes += romBytes.substring(i, i+3);
				}
			} else {
				newBytes += romBytes.substring(i, i+3);
			}
		}
		romBytes = newBytes;
	}
	
	function setRomFile(file) {
		console.log('RUNLUA:print("File: ' + file + '")');
	}
	
	function getBinaryData() {
		return romBytes;
	}
	
	function setFileType(type) {
		fileType = type;
	}
	
	function getFileType() {
		return fileType;
	}
	
	function resetEmulator() {
		romBytes = "";
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj != null) {
			var parDiv = flObj.parentNode;
			parDiv.removeChild(flObj);
			var emuDiv = document.createElement("DIV");
			emuDiv.id = "emulator";
			parDiv.appendChild(emuDiv);
		}
	}
	
	function setSaveState(str) {
		saveState = str;
		console.log("Saved state");
	}
	
	function saveGameState() {
		var flObj = document.getElementsByTagName("object")[0];
		flObj.saveFlashState();
		console.log("SAVED GAME STATE");
		console.log('RUNLUA:WriteSaveStateFile("' + getSaveState() + '")');
	}
	
	function getSaveState() {
		if(saveState == "")
			return getSaveState();
		else
			return saveState;
	}
	
	function setLoadState(str) {
		loadState = str;
		var flObj = document.getElementsByTagName("object")[0];
		flObj.loadFlashState();
	}
	
	function getLoadState() {
		return loadState;
	}
	
	window.setInterval(function() {
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj != null) {
			flObj.tabIndex = "-1";
			flObj.focus();
		}
		document.body.backgroundColor = "black";
	}, 1000/30);
	
</script>
</body>
</html>

<html>
<head>
	<title>GEMU</title>
	<style>
		html, body {
			margin: 1;
			height: 100%;
			overflow: hidden;
		}
		p {
			color:white;
			font-family:"Arial Black", Gadget, sans-serif;
		}
	</style>
</head>
<body>
<div>
	<div id="emulator">
		<p>To run GEMU, you must have the Adobe NPAPI plugin installed on your computer!
			Download here: https://get.adobe.com/flashplayer/otherversions/</p>
	</div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>

<script type="text/javascript">

	var romBytes = "";
	var fileType = "";
	var saveState = "";
	var loadState = "";
	
	var resizeOwnEmulator = function(width, height)
	{
		var emulator = $('#emulator');
		emulator.css('width', width);
		emulator.css('height', height);
	}
	
	function setUrl() {
		var emulator = $('#emulator');
		//console.log('RUNLUA:print("retrived bytes: ' + romBytes + '")');
		if(emulator)
		{
			var flashvars = 
			{
				system : fileType,
				url : ''
			};
			var params = {};
			var attributes = {};

			params.allowscriptaccess = 'sameDomain';
			params.allowFullScreen = 'true';
			params.allowFullScreenInteractive = 'true';

			swfobject.embedSWF('flash/Nesbox.swf', 'emulator', '640', '480', '11.2.0', 'flash/expressInstall.swf', flashvars, params, attributes, onFlashLoad);
		}
	}
	
	var onFlashLoad = function(e) {
		if(e.success) {
			var flObj = document.getElementsByTagName("object")[0];
			flObj.tabIndex = "-1";
			flObj.focus();
		}
	}
	
	function getFileFromByteArray(byteString) {
		var strBytes = byteString.split(" ");
		var bytes = [];
		for(i = 0; i < strBytes.length; i++) {
			bytes.push(parseInt(strBytes[i], 16));
		}
		var byteArray = new Uint8Array(bytes);
		var blob = new Blob([byteArray], {type: ""});
		var objectUrl = URL.createObjectURL(blob);
		return objectUrl;
		this.setUrl(objectUrl);
	}
	
	function setRomBytes(byteString) {
		romBytes = byteString;
	}
	
	function addToRomBytes(byteString) {
		romBytes += byteString;
	}
	
	function getBinaryData() {
		return romBytes;
	}
	
	function setFileType(type) {
		fileType = type;
	}
	
	function getFileType() {
		return fileType;
	}
	
	function resetEmulator() {
		romBytes = "";
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj != null) {
			var parDiv = flObj.parentNode;
			parDiv.removeChild(flObj);
			var emuDiv = document.createElement("DIV");
			emuDiv.id = "emulator";
			parDiv.appendChild(emuDiv);
		}
	}
	
	function setSaveState(str) {
		saveState = str;
		console.log("Saved state");
	}
	
	function saveGameState() {
		var flObj = document.getElementsByTagName("object")[0];
		flObj.saveFlashState();
		console.log("SAVED GAME STATE");
		console.log('RUNLUA:WriteSaveStateFile("' + getSaveState() + '")');
	}
	
	function getSaveState() {
		if(saveState == "")
			return getSaveState();
		else
			return saveState;
	}
	
	function setLoadState(str) {
		loadState = str;
		var flObj = document.getElementsByTagName("object")[0];
		flObj.loadFlashState();
	}
	
	function getLoadState() {
		return loadState;
	}
	
	window.setInterval(function() {
		var flObj = document.getElementsByTagName("object")[0];
		if(flObj != null) {
			flObj.tabIndex = "-1";
			flObj.focus();
		}
	}, 1000/30);
	
</script>
</body>
</html>
